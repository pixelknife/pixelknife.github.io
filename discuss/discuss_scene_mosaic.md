# 大幅面多景镶嵌



## 1 每景都做好正射工作

目前我们用的工具是ENVI上的RPC正射工具，目前来看误差还是不小，需要每景检测。这里误差来自几个方面，卫星提供的RPC文件本来就有误差，DEM精度也不够，自动找的控制点的精度和数量不够。



## 2 制作成标准化的16位TIFF图像

因为处理可能涉及很多软件，所以会对图像的一些性质有所变化。比如图像内容的部分会不会出现0导致和周边透明色混淆？正射等操作的导致的重采样会不会导致图像最外围一线出现一条既不是0也不是正常图像内容的过渡黑线（如果直接用几景这样的图像来拼接就会看到这样的黑线）？

这里的输入标准图像，有几个要点：

* 设置透明色0, "-a_nodata 0"，必须保证图像内容中不存在0（可以在正射之前+1以确保没有0）
* RGB三波段，把各个波段的描述明确定义。（如果有所差异，gdalbuildvrt无法准确运行）, "-co photometric=rgb"
* 将亮度空间调到0-65535，"-scale 0 1024 0 65536"
* 使用瓦块，"-co tiled=yes"
* 考虑使用一定压缩格式 "-co compress=deflate"，无损压缩中deflate的压缩率是最高的。
* 使用bigtiff格式，”-co bigtiff=yes"

光用GDAL现有的工具是不够的，我们开发了一个pkCopyNodata工具，将输入图像的外部NODATA=0提取出来，然后再往内推进一定像素（缺省10像素），把之前产生的非真正图像内容清理掉。


命令行批处理样例：

    MD clean
    
    FOR /F %I IN ('DIR GF*_PMS*.DAT /B') DO gdal_translate -of vrt -co photometric=rgb -scale 0 4096 0 65536 -b 3 -b 2 -b 1 %I %~nI.VRT
    
    FOR /F %I IN ('DIR GF*_PMS*.VRT /B') DO pkcopynodata -i %I -o clean\%~nI.TIF

将ENVI正射后的.DAT文件转换成标准化的TIF图像，放到CLEAN子目录中



## 3 同轨道的拼接

这里用拼接这个词，和镶嵌概念有所区分。这里说的是一个连续轨道上的多景有交叠区域的景之间的拼接。

前面步骤中提到因为处理算法的关系，输入图像周边可能有一两个像素的黑边。可以通过向图像内部缩小若干像素来清理干净，pkCopyNodata就是做这个的。

如果相邻两景正射后的偏差不超过一个像素，那么即使是简单gdalbuildvrt前后叠放，也可以让客户难以看到两景之间的边界。



## 4 缩略图调色



### 4.1 白平衡

以64米为一个基准尺度，这个是2米的32倍，是0.8米的80倍，是0.5米的128倍。

通过gdaladdo和gdal_translate制作64米分辨率的缩略图。

GE上有landsat的2020年数据，64米是L8的最高分辨率15米的4倍。根据待调色的图像缩略图的坐标，将事先下载的LS2020的相关区域图像生成出来。

在PS中将缩略图做快速增强，然后用铅笔工具（硬度100%）给那些认为是晴空的、和Landsat对应内容一致的地物加以标注。这是唯一需要一定人工工作量的步骤。

将标红的区域的待调色部分和Landsat2020部分比较，通过均值和方差的简单变化，将颜色调整到和标注图像接近，基本上解决了白平衡问题。



### 4.2 全局伽马校正

高分图像有所谓的肥尾现象，直方图集中在暗部，高亮的范围很大但是像素很少。

简单点说有比较暗的森林区域也有面积占比小但是特别亮的建筑区。图像如何能够充分反映所有的地物的信息就很重要。

先做一个伽马校正（全局的指数化调整），类似PS上的曲线调整， GDAL上的"-exponent 0.2"。这个时候暗区域充分扩大，而高亮区域压缩了。

pkColorStd : Color Standarize，颜色标准化，白平衡和伽马都在这里



### 4.3 局部暗区调整

再通过PS上的阴影高光工具，调整缩略图的局部的明暗程度。这个和上面的伽马变化的差别在于，可以不再挤压高亮区域，而独立调亮广大的暗区。但是photoshop直接处理超大图像的调色不现实，但是可以处理那个缩略图。过这样一个参考缩略图，通过色彩映射工具(pkThumbSim)制作大幅面图像的各个部分的颜色都设置在比较理想的位置上。这样图像将更加均匀。

pkThumbSim： Thumb image simulation



### 4.4 高亮点恢复

然后还可以利用高亮点的局部积聚特性，可以做局部的直方图调整(pkExpose)，进一步恢复高亮区域纹理。

最后两个步骤我现在觉得可能如果赶时间就不是特别必要，伽马校正之后就基本上可以了。

pkExpose: Expose Recover



### 4.5 锐化

在一两个像素范围内增强纹理信息。这作为pkExpose的一个参数选择。



## 5 matlab工具处理步骤

在matlab和GDAL命令行之间交互工作来完成整个流程

* 收集正射完成后的图像

* clean.bat 重新切割边缘，设定透明色 

* scene_path_bat.m 建构轨道，建构VRT文件

* scene_proc_bat.m 建构批处理

* make_small.bat 建立缩略图

* Photoshop 用铅笔工具标红

* warp_landsat_bat.m 建立对应的LANDSAT.TIF

* make_gamma.bat 白平衡、伽马调整、拉伸 

* Photoshop 用高光/阴影工具制作缩略图映射

* make_tsim.bat 缩略图迁移到大图，去饱和

  





---

**联系方式**

陈甫 副研究员
中国科学院空天信息创新研究院
chenfu@aircas.ac.cn
13811147935

